<!DOCTYPE html>
<html lang="zh">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>Nightly Reflection</title>

<!-- PWA -->
<link rel="manifest" href="manifest.json" />
<link rel="apple-touch-icon" href="icon-192.png" />
<meta name="apple-mobile-web-app-capable" content="yes" />
<meta name="apple-mobile-web-app-status-bar-style" content="default" />

<style>
  :root {
    --vh: 1vh;
    --radius: 18px;
    --shadow: 0 12px 32px rgba(0,0,0,0.12);
  }

  body {
    margin: 0;
    padding: env(safe-area-inset-top) env(safe-area-inset-right)
             env(safe-area-inset-bottom) env(safe-area-inset-left);
    background: #f4f6fb;
    font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", system-ui, sans-serif;
    color: #111;
    display: flex;
    justify-content: center;
    min-height: calc(var(--vh) * 100);
  }

  .app {
    width: 100%;
    max-width: 650px;
    background: #fff;
    margin-top: 20px;
    border-radius: 24px;
    padding: 26px 22px 40px;
    box-shadow: var(--shadow);
  }

  h1 {
    margin: 0;
    font-size: 24px;
    font-weight: 700;
  }

  .subtitle {
    font-size: 14px;
    color: #666;
    margin-bottom: 24px;
  }

  h3 {
    margin: 20px 0 8px;
    font-size: 15px;
    font-weight: 600;
  }

  textarea {
    width: 100%;
    min-height: 80px;
    padding: 14px;
    border-radius: var(--radius);
    border: 1px solid #d1d5db;
    resize: vertical;
    font-size: 15px;
    outline: none;
    background: #fafafa;
    transition: 0.2s;
  }

  textarea:focus {
    border-color: #60a5fa;
    background: #fff;
    box-shadow: 0 0 0 2px rgba(96,165,250,0.25);
  }

  .btn {
    width: 100%;
    padding: 15px;
    border-radius: 999px;
    font-size: 16px;
    font-weight: 600;
    cursor: pointer;
    margin-top: 16px;
    border: none;
  }

  .primary {
    background: linear-gradient(90deg, #60a5fa, #3b82f6);
    color: #fff;
    box-shadow: 0 6px 20px rgba(96,165,250,0.4);
  }

  .secondary {
    background: #fff;
    border: 1px solid #ddd;
    color: #333;
  }

  .helper {
    margin-top: 12px;
    font-size: 13px;
    color: #888;
  }

  /* ğŸ”¥ å†å²è®°å½• */
  .log-item {
    background: #f9fafb;
    border: 1px solid #eee;
    padding: 14px;
    border-radius: var(--radius);
    font-size: 14px;
    margin-bottom: 12px;
    line-height: 1.5;
  }
  .log-item b {
    font-size: 14px;
    display: block;
    margin-bottom: 6px;
  }

  .log-actions button {
    margin-top: 10px;
    padding: 6px 12px;
    font-size: 12px;
    border-radius: 999px;
    border: 1px solid #ccc;
    background: #fff;
    cursor: pointer;
  }
</style>

<script>
// ===== iPhone 100vh Fix =====
function fixVH() {
  document.documentElement.style.setProperty("--vh", window.innerHeight * 0.01 + "px");
}
window.addEventListener("resize", fixVH);
window.addEventListener("orientationchange", fixVH);
fixVH();
</script>
</head>

<body>
<div class="app">
  <h1>âœ¨ Nightly Reflection</h1>
  <div class="subtitle">ç¡å‰ 1 åˆ†é’Ÿï¼ŒæŠŠä»Šå¤©æ”¶å¥½ï¼Œæ˜å¤©è½»ä¸€ç‚¹ã€‚</div>

  <h3>1. ä»Šå¤©çš„äº®ç‚¹</h3>
  <textarea id="highlight" placeholder="å†™ä¸€ç‚¹ç‚¹å°±å¥½"></textarea>

  <h3>2. ä»Šå¤©çš„å¡ç‚¹</h3>
  <textarea id="block" placeholder="æ˜¯ä»€ä¹ˆè®©ä½ å¡ä½ï¼Ÿ"></textarea>

  <h3>3. æ˜å¤©çš„å°åŠ¨ä½œ</h3>
  <textarea id="action" placeholder="æ˜å¤©åšä¸€ä»¶å¾ˆå°çš„äº‹"></textarea>

  <button class="btn primary" id="saveBtn">è®°å½•ä»Šå¤©</button>
  <button class="btn secondary" id="analyzeBtn">âœ¨ ä¸€é”®ç”¨ ChatGPT åˆ†æ</button>

  <div class="helper" id="statusText"></div>

  <h3 style="margin-top:28px;">å†å²è®°å½•</h3>
  <div id="logList"></div>
</div>

<script>
// =====================================
// CONFIG
// =====================================
const STORAGE_KEY = "nightLogs";
const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzQb1W-8Cu6maVPkpKHqLDmBfZVycJ1dQjTFUT3Qawq-gUHGGiJKc-yoBpVqxv1COKs1A/exec";

// =====================================
// Local Storage
// =====================================
function getLogs() {
  try { return JSON.parse(localStorage.getItem(STORAGE_KEY) || "[]"); }
  catch { return []; }
}
function setLogs(list) {
  localStorage.setItem(STORAGE_KEY, JSON.stringify(list));
}

// =====================================
// Render Logs
// =====================================
function renderLogs() {
  const logs = getLogs();
  const box = document.getElementById("logList");
  box.innerHTML = "";

  logs.forEach((l, i) => {
    const div = document.createElement("div");
    div.className = "log-item";
    div.innerHTML = `
      <b>${l.date}</b>
      ğŸŒŸ ${l.highlight || "â€”"}<br>
      ğŸ” ${l.block || "â€”"}<br>
      â–¶ï¸ ${l.action || "â€”"}<br>
      <div class="log-actions">
        <button onclick="editLog(${i})">ç¼–è¾‘</button>
      </div>
    `;
    box.appendChild(div);
  });
}

// =====================================
// Edit
// =====================================
let editingIndex = null;
function editLog(i) {
  const logs = getLogs();
  const x = logs[i];
  editingIndex = i;

  highlight.value = x.highlight;
  block.value = x.block;
  action.value = x.action;

  statusText.textContent = "æ­£åœ¨ç¼–è¾‘ï¼Œä¿®æ”¹åç‚¹å‡»â€œè®°å½•ä»Šå¤©â€ä¿å­˜";
}

// =====================================
// SAVE
// =====================================
async function save() {
  const highlight = document.getElementById("highlight").value.trim();
  const block = document.getElementById("block").value.trim();
  const action = document.getElementById("action").value.trim();

  if (!highlight && !block && !action) {
    return alert("è‡³å°‘å†™ä¸€ç‚¹ç‚¹å–”ï¼");
  }

  let logs = getLogs();

  // ---- edit mode ----
  if (editingIndex !== null) {
    logs[editingIndex] = { ...logs[editingIndex], highlight, block, action };
    setLogs(logs);
    renderLogs();
    editingIndex = null;
    statusText.textContent = "å·²æ›´æ–°ï¼ˆæœ¬åœ°ï¼‰";
    return;
  }

  // ---- new record ----
  const date = new Date().toISOString().slice(0,10);
  logs.unshift({ date, highlight, block, action });
  setLogs(logs);
  renderLogs();

  statusText.textContent = "æ­£åœ¨åŒæ­¥åˆ° Google Sheetâ€¦";

  try {
    await fetch(SCRIPT_URL, {
      method: "POST",
      mode: "no-cors",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ date, highlight, block, action })
    });
    statusText.textContent = "å·²åŒæ­¥åˆ° Google Sheet âœ”";
  } catch (e) {
    statusText.textContent = "æœ¬åœ°ä¿å­˜æˆåŠŸï¼Œä½†åŒæ­¥å¤±è´¥ã€‚";
  }
}

function analyze() {
  const logs = getLogs();
  if (!logs.length) {
    alert("è¿˜æ²¡æœ‰è®°å½•");
    return;
  }

  const recent = logs.slice(0, 7)
    .map(l => `æ—¥æœŸï¼š${l.date}\näº®ç‚¹ï¼š${l.highlight}\nå¡ç‚¹ï¼š${l.block}\næ˜å¤©çš„å°åŠ¨ä½œï¼š${l.action}`)
    .join("\n\n");

  const prompt =
`ä»¥ä¸‹æ˜¯æˆ‘æœ€è¿‘ 7 å¤©çš„ Nightly Reflectionï¼Œè¯·å¸®æˆ‘åšæ·±åº¦åˆ†æã€‚

${recent}

è¯·æ ¹æ®ä½ çš„è®¾å®šè¾“å‡ºï¼š

1. è¿‡å» 7 å¤©æ€»ç»“  
2. æœ€å¸¸å‡ºç°çš„äº®ç‚¹ï¼ˆTop 3ï¼‰  
3. æœ€å¸¸å‡ºç°çš„å¡ç‚¹ï¼ˆTop 3ï¼‰  
4. å¯è§‚å¯Ÿåˆ°çš„è¶‹åŠ¿ï¼ˆ3 ç‚¹ï¼‰  
5. æˆ‘çš„ DISC å€¾å‘å˜åŒ–ï¼ˆè½»é‡åˆ†æï¼‰  
6. æ˜å¤©å¯¹æˆ‘æœ€æœ‰å¸®åŠ©çš„ä¸€ä¸ªå°åŠ¨ä½œ  
7. ä¸€å¥æˆç†Ÿã€æ¸©æŸ”ã€ä¸æ²¹è…»çš„é¼“åŠ±  
`;

  navigator.clipboard.writeText(prompt)
    .then(() => {
      alert("æ€»ç»“å·²å¤åˆ¶\næ¥ä¸‹æ¥ä¼šè‡ªåŠ¨æ‰“å¼€ä½ çš„ã€ŒKai Nightly Reflection Analyzerã€GPT");

      // è·³è½¬åˆ°ä½ çš„ GPTï¼ˆä¸“å±é“¾æ¥ï¼‰
      window.location.href = "https://chatgpt.com/g/g-6926c2b7d6f08191bcc7c822996bd7c8-kai-nightly-reflection-analyzer";
    });
}

// =====================================
// Event Listeners
// =====================================
saveBtn.onclick = save;
analyzeBtn.onclick = analyze;
renderLogs();

// =====================================
// PWA Service Worker
// =====================================
if ("serviceWorker" in navigator) {
  navigator.serviceWorker.register("./service-worker.js");
}
</script>

</body>
</html>
