<!DOCTYPE html>
<html lang="zh">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>Nightly Reflection</title>

<!-- PWA -->
<link rel="manifest" href="manifest.json" />
<link rel="apple-touch-icon" href="icon-192.png" />
<meta name="apple-mobile-web-app-capable" content="yes" />
<meta name="apple-mobile-web-app-status-bar-style" content="default" />

<style>
/* ============ iPhone Safe Area ä¿®å¤ ============ */
:root {
  --vh: 1vh;
  --radius: 18px;
  --card-shadow: 0 6px 20px rgba(0,0,0,0.06);
  --blue: #3b82f6;
  --blue-light: #60a5fa;
}

/* ä¿®å¤ iPhone Safari 100vh é—®é¢˜ */
body {
  margin: 0;
  padding: env(safe-area-inset-top) env(safe-area-inset-right)
           env(safe-area-inset-bottom) env(safe-area-inset-left);
  background: #f3f4f6;
  font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", system-ui, sans-serif;
  color: #111;
  display: flex;
  justify-content: center;
  min-height: calc(var(--vh) * 100);
}

/* ============ å¡ç‰‡å®¹å™¨ ============ */
.app {
  width: 100%;
  max-width: 680px;
  margin-top: 18px;
  
  background: #ffffff;
  border-radius: 28px;
  padding: 32px 26px 40px;
  box-shadow: var(--card-shadow);
}

/* ============ æ ‡é¢˜åŒº ============ */
h1 {
  margin: 0;
  font-size: 28px;
  font-weight: 800;
  letter-spacing: -0.5px;
}

.subtitle {
  margin-top: 6px;
  font-size: 14px;
  color: #6b7280;
  line-height: 1.4;
}

/* ============ Section æ ‡é¢˜ ============ */
.section-title {
  margin-top: 28px;
  margin-bottom: 6px;
  font-size: 16px;
  font-weight: 600;
}

/* ============ è¾“å…¥æ¡† ============ */
textarea {
  width: 100%;
  min-height: 92px;
  padding: 14px 16px;
  border-radius: 18px;
  border: 1px solid #e5e7eb;
  resize: vertical;
  font-size: 15px;
  background: #fafafa;
  outline: none;
  transition: all 0.2s ease;
}

textarea:focus {
  border-color: var(--blue-light);
  background: #fff;
  box-shadow: 0 0 0 2px rgba(96,165,250,0.25);
}

/* ============ Buttons ============ */
.btn {
  width: 100%;
  padding: 16px;
  border-radius: 30px;
  font-size: 17px;
  font-weight: 600;
  border: none;
  margin-top: 18px;
  cursor: pointer;
}

.primary {
  background: linear-gradient(90deg, var(--blue-light), var(--blue));
  color: #fff;
  box-shadow: 0 6px 18px rgba(59,130,246,0.35);
}

.secondary {
  background: #ffffff;
  border: 1px solid #e5e7eb;
  color: #374151;
}

/* ============ Helper text ============ */
.helper {
  margin-top: 10px;
  font-size: 13px;
  color: #9ca3af;
}

/* ============ å†å²è®°å½• ============ */
#logList {
  margin-top: 14px;
}

.log-item {
  background: #fafafa;
  border: 1px solid #e5e7eb;
  padding: 16px 18px;
  border-radius: 20px;
  font-size: 14px;
  line-height: 1.55;
  margin-bottom: 14px;
}

.log-item b {
  font-size: 15px;
  display: block;
  margin-bottom: 6px;
}

.log-actions button {
  margin-top: 10px;
  padding: 6px 14px;
  font-size: 12px;
  border-radius: 20px;
  border: 1px solid #d1d5db;
  background: #fff;
  cursor: pointer;
}

/* ä¿®å¤é«˜åº¦è®¡ç®— */
@supports (-webkit-touch-callout: none) {
  .app {
    min-height: calc(var(--vh) * 100 - 20px);
  }
}
</style>

<script>
// Safari 100vh fix
function fixVH() {
  document.documentElement.style.setProperty("--vh", window.innerHeight * 0.01 + "px");
}
window.addEventListener("resize", fixVH);
window.addEventListener("orientationchange", fixVH);
fixVH();
</script>
</head>

<body>

<div class="app">

  <h1>âœ¨ Nightly Reflection</h1>
  <div class="subtitle">ç¡å‰ 1 åˆ†é’Ÿï¼ŒæŠŠä»Šå¤©æ”¶å¥½ï¼Œæ˜å¤©è½»ä¸€ç‚¹ã€‚</div>

  <div class="section-title">1. ä»Šå¤©çš„äº®ç‚¹</div>
  <textarea id="highlight" placeholder="å†™ä¸€ç‚¹ç‚¹å°±å¥½"></textarea>

  <div class="section-title">2. ä»Šå¤©çš„å¡ç‚¹</div>
  <textarea id="block" placeholder="æ˜¯ä»€ä¹ˆè®©ä½ å¡ä½ï¼Ÿ"></textarea>

  <div class="section-title">3. æ˜å¤©çš„å°åŠ¨ä½œ</div>
  <textarea id="action" placeholder="æ˜å¤©åšä¸€ä»¶å¾ˆå°çš„äº‹"></textarea>

  <button class="btn primary" id="saveBtn">è®°å½•ä»Šå¤©</button>
  <button class="btn secondary" id="analyzeBtn">âœ¨ ä¸€é”®ç”¨ ChatGPT åˆ†æ</button>

  <div class="helper" id="statusText"></div>

  <div class="section-title" style="margin-top: 36px;">å†å²è®°å½•</div>
  <div id="logList"></div>
</div>

<script>
/* ====== ä½ çš„ JS ï¼ˆä¸åŠ¨ï¼‰ ====== */
const STORAGE_KEY="nightLogs";
const SCRIPT_URL="https://script.google.com/macros/s/AKfycbzQb1W-8Cu6maVPkpKHqLDmBfZVycJ1dQjTFUT3Qawq-gUHGGiJKc-yoBpVqxv1COKs1A/exec";

function getLogs(){try{return JSON.parse(localStorage.getItem(STORAGE_KEY)||"[]")}catch{return[]}}
function setLogs(l){localStorage.setItem(STORAGE_KEY,JSON.stringify(l))}

function renderLogs(){
  const logs=getLogs();
  const box=document.getElementById("logList");
  box.innerHTML="";
  logs.forEach((l,i)=>{
    const div=document.createElement("div");
    div.className="log-item";
    div.innerHTML=`
      <b>${l.date}</b>
      ğŸŒŸ ${l.highlight||"â€”"}<br>
      ğŸ” ${l.block||"â€”"}<br>
      â–¶ï¸ ${l.action||"â€”"}<br>
      <div class="log-actions">
        <button onclick="editLog(${i})">ç¼–è¾‘</button>
      </div>`;
    box.appendChild(div);
  });
}

let editingIndex=null;
function editLog(i){
  const logs=getLogs();
  const x=logs[i];
  editingIndex=i;
  highlight.value=x.highlight;
  block.value=x.block;
  action.value=x.action;
  statusText.textContent="æ­£åœ¨ç¼–è¾‘ï¼Œä¿®æ”¹åç‚¹å‡»â€œè®°å½•ä»Šå¤©â€ä¿å­˜";
}

async function save(){
  const highlightVal=highlight.value.trim();
  const blockVal=block.value.trim();
  const actionVal=action.value.trim();
  if(!highlightVal&&!blockVal&&!actionVal)return alert("è‡³å°‘å†™ä¸€ç‚¹ç‚¹å–”ï¼");
  let logs=getLogs();

  if(editingIndex!==null){
    logs[editingIndex]={...logs[editingIndex],highlight:highlightVal,block:blockVal,action:actionVal};
    setLogs(logs);
    renderLogs();
    editingIndex=null;
    statusText.textContent="å·²æ›´æ–°ï¼ˆæœ¬åœ°ï¼‰";
    return;
  }

  const date=new Date().toISOString().slice(0,10);
  logs.unshift({date,highlight:highlightVal,block:blockVal,action:actionVal});
  setLogs(logs);
  renderLogs();
  statusText.textContent="æ­£åœ¨åŒæ­¥åˆ° Google Sheetâ€¦";

  try{
    await fetch(SCRIPT_URL,{
      method:"POST",
      mode:"no-cors",
      headers:{"Content-Type":"application/json"},
      body:JSON.stringify({date,highlight:highlightVal,block:blockVal,action:actionVal})
    });
    statusText.textContent="å·²åŒæ­¥åˆ° Google Sheet âœ”";
  }catch(e){
    statusText.textContent="æœ¬åœ°ä¿å­˜æˆåŠŸï¼Œä½†åŒæ­¥å¤±è´¥ã€‚";
  }
}

function analyze(){
  const logs=getLogs();
  if(!logs.length)return alert("è¿˜æ²¡æœ‰è®°å½•");
  const recent=logs.slice(0,7)
    .map(l=>`æ—¥æœŸï¼š${l.date}\näº®ç‚¹ï¼š${l.highlight}\nå¡ç‚¹ï¼š${l.block}\næ˜å¤©çš„å°åŠ¨ä½œï¼š${l.action}`)
    .join("\n\n");
  const prompt=
`ä»¥ä¸‹æ˜¯æˆ‘æœ€è¿‘ 7 å¤©çš„ Nightly Reflectionï¼Œè¯·å¸®æˆ‘åšæ·±åº¦åˆ†æï¼š

${recent}

è¯·è¾“å‡ºï¼š

1. ä»Šå¤©ä¸€å¥è¯æ€»ç»“  
2. è¿™å‘¨ä¸€å¥è¯è¶‹åŠ¿  
3. æ˜å¤©ä¸€å¥è¯å»ºè®®  
  `;
  navigator.clipboard.writeText(prompt).then(()=>{
    alert("æ€»ç»“å·²å¤åˆ¶ï¼Œå°†å¸¦ä½ å‰å¾€ Kai Nightly Reflection GPT åˆ†æ");
    window.location.href="https://chatgpt.com/g/g-6926c2b7d6f08191bcc7c822996bd7c8-kai-nightly-reflection-analyzer";
  });
}

saveBtn.onclick=save;
analyzeBtn.onclick=analyze;
renderLogs();

if("serviceWorker" in navigator){
  navigator.serviceWorker.register("./service-worker.js");
}
</script>

</body>
</html>
