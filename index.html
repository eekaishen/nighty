<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Nightly Reflection Â· Kai</title>
  <style>
    body {
      margin: 0;
      font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", system-ui, sans-serif;
      background: #f5f7fb;
      color: #111827;
    }
    .shell {
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 32px 16px;
    }
    .app {
      width: 100%;
      max-width: 640px;
      background: #ffffff;
      border-radius: 28px;
      padding: 24px 20px 28px;
      box-shadow: 0 18px 45px rgba(15, 23, 42, 0.10);
      border: 1px solid #e5e7eb;
    }
    h1 {
      margin: 0 0 4px;
      font-size: 22px;
      font-weight: 700;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .subtitle {
      font-size: 13px;
      color: #6b7280;
      margin-bottom: 18px;
    }
    h3 {
      margin: 14px 0 4px;
      font-size: 14px;
      font-weight: 600;
      color: #111827;
    }
    textarea {
      width: 100%;
      box-sizing: border-box;
      min-height: 70px;
      border-radius: 16px;
      border: 1px solid #d1d5db;
      padding: 10px 12px;
      font-size: 14px;
      resize: vertical;
      outline: none;
      background: #ffffff;
    }
    textarea:focus {
      border-color: #60a5fa;
      box-shadow: 0 0 0 1px rgba(37, 99, 235, 0.25);
    }
    button.primary {
      width: 100%;
      margin-top: 20px;
      padding: 13px 16px;
      border-radius: 999px;
      border: none;
      background: linear-gradient(90deg,#60a5fa,#3b82f6);
      color: #ffffff;
      font-size: 15px;
      font-weight: 600;
      cursor: pointer;
      box-shadow: 0 12px 30px rgba(37, 99, 235, 0.45);
    }
    button.secondary {
      width: 100%;
      margin-top: 10px;
      padding: 11px 16px;
      border-radius: 999px;
      border: 1px solid #e5e7eb;
      background: #ffffff;
      color: #374151;
      font-size: 14px;
      cursor: pointer;
    }
    .section-title {
      margin-top: 26px;
      font-size: 16px;
      font-weight: 600;
    }
    .log-list {
      margin-top: 10px;
      max-height: 260px;
      overflow-y: auto;
    }
    .log-item {
      padding: 11px 12px;
      border-radius: 18px;
      background: #f9fafb;
      border: 1px solid #e5e7eb;
      font-size: 13px;
      margin-bottom: 8px;
    }
    .log-date {
      font-size: 12px;
      font-weight: 600;
      color: #111827;
      margin-bottom: 4px;
    }
    .log-line { margin: 1px 0; }
    .log-actions {
      margin-top: 6px;
      display: flex;
      gap: 8px;
    }
    .mini-btn {
      padding: 5px 10px;
      border-radius: 999px;
      border: 1px solid #d1d5db;
      background: #ffffff;
      font-size: 11px;
      cursor: pointer;
    }
    .helper {
      margin-top: 6px;
      font-size: 11px;
      color: #9ca3af;
    }
  </style>
</head>

<body>
<div class="shell">
  <div class="app">
    <h1>âœ¨ Nightly Reflection</h1>
    <div class="subtitle">ç™½è‰²æç®€ Â· ç¡å‰ 1 åˆ†é’Ÿï¼ŒæŠŠä»Šå¤©æ”¶å¥½ï¼Œæ˜å¤©è½»ä¸€ç‚¹ã€‚</div>

    <h3>1. ä»Šå¤©çš„äº®ç‚¹ï¼ˆä¸éœ€è¦å¾ˆå¤§ï¼‰</h3>
    <textarea id="highlight" placeholder="ä»Šå¤©æœ‰ä»€ä¹ˆå€¼å¾—è¢«è®°ä½çš„ä¸€ç¬é—´ï¼Ÿ"></textarea>

    <h3>2. ä»Šå¤©çš„å¡ç‚¹ï¼ˆä¸€å¥è¯ï¼‰</h3>
    <textarea id="block" placeholder="å“ªé‡Œè®©ä½ å¡ä½ / ä¸èˆ’æœ / çŠ¹è±«äº†ä¸€ä¸‹ï¼Ÿ "></textarea>

    <h3>3. æ˜å¤©çš„ä¸€ä¸ªå°åŠ¨ä½œï¼ˆ1 åˆ†é’Ÿå†…èƒ½å®Œæˆï¼‰</h3>
    <textarea id="action" placeholder="æ˜å¤©åªè¦åšè¿™ä¸€ç‚¹ç‚¹ï¼Œå°±ç®—å¯¹è‡ªå·±æœ‰äº¤ä»£ã€‚"></textarea>

    <button class="primary" id="saveBtn">è®°å½•ä»Šå¤©çš„åæ€</button>
    <button class="secondary" id="analyzeBtn">âœ¨ ä¸€é”®åˆ†ææœ€è¿‘ 7 å¤©</button>

    <div class="helper" id="statusText"></div>

    <div class="section-title">å†å²è®°å½•</div>
    <div id="logList" class="log-list"></div>
  </div>
</div>

<script>
// =======================================================
// Kai Â· Nightly Reflection App
// =======================================================

const STORAGE_KEY = 'nightLogs';
const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzQb1W-8Cu6maVPkpKHqLDmBfZVycJ1dQjTFUT3Qawq-gUHGGiJKc-yoBpVqxv1COKs1A/exec';

let editingIndex = null;

// ----- LocalStorage -----
function getLogs() {
  try { return JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]'); }
  catch { return []; }
}

function setLogs(list) {
  localStorage.setItem(STORAGE_KEY, JSON.stringify(list));
}

// ----- Render Logs -----
function renderLogs() {
  const logs = getLogs();
  const box = document.getElementById('logList');
  box.innerHTML = '';

  if (!logs.length) {
    box.innerHTML = '<div style="font-size:12px;color:#9ca3af;">è¿˜æ²¡æœ‰è®°å½•ï¼Œä»Šæ™šå¯ä»¥ä»ç¬¬ä¸€æ¡å¼€å§‹ã€‚</div>';
    return;
  }

  logs.forEach((l, idx) => {
    const div = document.createElement('div');
    div.className = 'log-item';
    div.innerHTML = `
      <div class="log-date">${l.date}</div>
      <div class="log-line">ğŸŒŸ äº®ç‚¹ï¼š${l.highlight || 'â€”'}</div>
      <div class="log-line">ğŸ” å¡ç‚¹ï¼š${l.block || 'â€”'}</div>
      <div class="log-line">â–¶ï¸ æ˜å¤©åŠ¨ä½œï¼š${l.action || 'â€”'}</div>
      <div class="log-actions">
        <button class="mini-btn" onclick="editLog(${idx})">ç¼–è¾‘</button>
      </div>
    `;
    box.appendChild(div);
  });
}

// ----- Clear Inputs -----
function clearInputs() {
  document.getElementById('highlight').value = '';
  document.getElementById('block').value = '';
  document.getElementById('action').value = '';
}

// ----- Edit Mode -----
function editLog(index) {
  const logs = getLogs();
  const item = logs[index];
  if (!item) return;

  editingIndex = index;
  document.getElementById('highlight').value = item.highlight;
  document.getElementById('block').value = item.block;
  document.getElementById('action').value = item.action;

  document.getElementById('statusText').textContent =
    'æ­£åœ¨ç¼–è¾‘è¿™ä¸€å¤©ï¼Œä¿®æ”¹åç‚¹å‡»â€œè®°å½•ä»Šå¤©çš„åæ€â€ä¿å­˜ã€‚';
}

// ----- Save -----
async function save() {
  const highlight = document.getElementById('highlight').value.trim();
  const block = document.getElementById('block').value.trim();
  const action = document.getElementById('action').value.trim();
  const status = document.getElementById('statusText');

  if (!highlight && !block && !action) {
    alert('è‡³å°‘å†™ä¸€ç‚¹ç‚¹å–”ï¼');
    return;
  }

  const logs = getLogs();

  // --- Editing ---
  if (editingIndex !== null) {
    logs[editingIndex].highlight = highlight;
    logs[editingIndex].block = block;
    logs[editingIndex].action = action;

    setLogs(logs);
    renderLogs();
    clearInputs();
    status.textContent = 'å·²æ›´æ–°ï¼ˆæœ¬åœ°ï¼‰ã€‚å¦‚è¦åŒæ­¥è‡³ Sheetï¼Œè¯·æ–°å¢ä¸€æ¡è®°å½•ã€‚';

    editingIndex = null;
    return;
  }

  // --- New Entry ---
  const date = new Date().toISOString().slice(0, 10);
  logs.unshift({ date, highlight, block, action });
  setLogs(logs);

  renderLogs();
  clearInputs();

  // --- Sync to Google Sheet ---
  status.textContent = 'æ­£åœ¨åŒæ­¥åˆ° Google Sheetâ€¦';

  try {
    await fetch(SCRIPT_URL, {
      method: 'POST',
      mode: 'no-cors',     // â­â­â­ å¿…é¡»æ·»åŠ çš„è·¨åŸŸè§£å†³æ–¹æ¡ˆ â­â­â­
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ date, highlight, block, action })
    });

    status.textContent = 'å·²è®°å½•å¹¶åŒæ­¥ï¼ˆåå°å¤„ç†ï¼‰âœ…';

  } catch (err) {
    console.error('åŒæ­¥å¤±è´¥', err);
    status.textContent = 'å·²åœ¨æœ¬åœ°ä¿å­˜ï¼Œä½†åŒæ­¥å¤±è´¥ï¼ˆå¯ç¨åé‡è¯•ï¼‰';
  }
}

// ----- AI-like Analysis -----
function analyze() {
  const logs = getLogs();
  if (!logs.length) {
    alert('è¿˜æ²¡æœ‰ä»»ä½•è®°å½•å¯ä»¥åˆ†æã€‚');
    return;
  }

  const recent = logs.slice(0, 7);
  const highlights = recent.map(l => l.highlight).filter(Boolean);
  const blocks = recent.map(l => l.block).filter(Boolean);
  const today = recent[0];

  let output = `âœ¨ æœ€è¿‘ ${recent.length} å¤©ï¼Œä½ æŒç»­åœ¨è®°å½•ã€‚\n\n`;

  if (highlights.length) {
    output += `ğŸŒŸ å¸¸å‡ºç°çš„äº®ç‚¹ï¼š\n- ${highlights.slice(0, 3).join('\n- ')}\n\n`;
  }

  if (blocks.length) {
    output += `ğŸ” å¸¸å‡ºç°çš„å¡ç‚¹ï¼š\n- ${blocks.slice(0, 3).join('\n- ')}\n\n`;
  }

  if (today) {
    output += `ğŸ’¡ ä»Šå¤©ï¼š\näº®ç‚¹ï¼š${today.highlight}\nå¡ç‚¹ï¼š${today.block}\næ˜å¤©åŠ¨ä½œï¼š${today.action}\n\n`;
  }

  output += `ğŸ§­ æ˜å¤©å»ºè®®ï¼š\n- å»¶ç»­ä¸€ä¸ªè®©ä½ èˆ’æœçš„å°åŠ¨ä½œ\n- å¯¹ä¸€ä¸ªå¡ç‚¹â€œåªæ¨è¿› 1 å…¬åˆ†â€`;

  alert(output);
}

// ----- Init -----
document.getElementById('saveBtn').addEventListener('click', save);
document.getElementById('analyzeBtn').addEventListener('click', analyze);

renderLogs();
</script>

</body>
</html>
