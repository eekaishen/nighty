<!DOCTYPE html>
<html lang="zh">
<head>

  <link rel="apple-touch-icon" href="icon-192.png">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="default">
  
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Nightly Reflection</title>

  <!-- PWA Manifest -->
  <link rel="manifest" href="manifest.json" />

  <style>
    body {
      margin: 0;
      background: #f4f6fb;
      font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", system-ui, sans-serif;
      display: flex;
      justify-content: center;
      padding: 30px 16px;
      color: #111;
    }
    .app {
      width: 100%;
      max-width: 650px;
      background: #fff;
      border-radius: 20px;
      padding: 24px;
      box-shadow: 0 10px 35px rgba(0,0,0,0.12);
    }
    h1 {
      margin: 0 0 10px;
      font-size: 22px;
      font-weight: 700;
    }
    .subtitle {
      font-size: 13px;
      color: #666;
      margin-bottom: 20px;
    }
    h3 {
      margin: 16px 0 8px;
      font-size: 14px;
      font-weight: 600;
    }
    textarea {
      width: 100%;
      min-height: 70px;
      padding: 12px;
      border-radius: 12px;
      border: 1px solid #d1d5db;
      resize: vertical;
      font-size: 14px;
      outline: none;
    }
    textarea:focus {
      border-color: #60a5fa;
      box-shadow: 0 0 0 1px rgba(96,165,250,0.4);
    }
    button {
      width: 100%;
      padding: 14px;
      border-radius: 999px;
      border: none;
      margin-top: 14px;
      font-size: 15px;
      font-weight: 600;
      cursor: pointer;
    }
    .primary {
      background: linear-gradient(90deg, #60a5fa, #3b82f6);
      color: white;
      box-shadow: 0 5px 20px rgba(99,102,241,0.4);
    }
    .secondary {
      background: #fff;
      border: 1px solid #ddd;
      color: #333;
    }
    .helper {
      margin-top: 10px;
      font-size: 12px;
      color: #888;
    }
    .log-item {
      background: #f9fafb;
      border: 1px solid #eee;
      padding: 12px;
      border-radius: 12px;
      font-size: 13px;
      margin-bottom: 10px;
    }
    .log-actions button {
      margin-top: 6px;
      padding: 5px 10px;
      font-size: 11px;
      border-radius: 999px;
      border: 1px solid #ccc;
      background: #fff;
      cursor: pointer;
    }
  </style>
</head>

<body>

<div class="app">
  <h1>âœ¨ Nightly Reflection</h1>
  <div class="subtitle">ç¡å‰ 1 åˆ†é’Ÿï¼ŒæŠŠä»Šå¤©æ”¶å¥½ï¼Œæ˜å¤©è½»ä¸€ç‚¹ã€‚</div>

  <h3>1. ä»Šå¤©çš„äº®ç‚¹</h3>
  <textarea id="highlight" placeholder="å†™ä¸€ç‚¹ç‚¹å°±å¯ä»¥"></textarea>

  <h3>2. ä»Šå¤©çš„å¡ç‚¹</h3>
  <textarea id="block" placeholder="æ˜¯ä»€ä¹ˆè®©ä½ å¡ä½ï¼Ÿ"></textarea>

  <h3>3. æ˜å¤©çš„å°åŠ¨ä½œ</h3>
  <textarea id="action" placeholder="æ˜å¤©åšä¸€ä»¶å¾ˆå°çš„äº‹"></textarea>

  <button class="primary" id="saveBtn">è®°å½•ä»Šå¤©çš„åæ€</button>
  <button class="secondary" id="analyzeBtn">âœ¨ ä¸€é”®åˆ†ææœ€è¿‘ 7 å¤©</button>

  <div class="helper" id="statusText"></div>

  <h3 style="margin-top:24px;">å†å²è®°å½•</h3>
  <div id="logList"></div>
</div>


<script>
// ================================
// CONFIG
// ================================
const STORAGE_KEY = "nightLogs";

// <<<< YOUR SHEET API >>>>
const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzQb1W-8Cu6maVPkpKHqLDmBfZVycJ1dQjTFUT3Qawq-gUHGGiJKc-yoBpVqxv1COKs1A/exec";

// ================================
// LocalStorage Functions
// ================================
function getLogs() {
  try { return JSON.parse(localStorage.getItem(STORAGE_KEY) || "[]"); }
  catch { return []; }
}

function setLogs(list) {
  localStorage.setItem(STORAGE_KEY, JSON.stringify(list));
}

// ================================
// Render Logs
// ================================
function renderLogs() {
  const logs = getLogs();
  const box = document.getElementById("logList");
  box.innerHTML = "";

  logs.forEach((l, i) => {
    const item = document.createElement("div");
    item.className = "log-item";
    item.innerHTML = `
      <div><b>${l.date}</b></div>
      ğŸŒŸ ${l.highlight || "â€”"}<br>
      ğŸ” ${l.block || "â€”"}<br>
      â–¶ï¸ ${l.action || "â€”"}<br>
      <div class="log-actions">
        <button onclick="editLog(${i})">ç¼–è¾‘</button>
      </div>
    `;
    box.appendChild(item);
  });
}

// ================================
// Edit
// ================================
let editingIndex = null;

function editLog(i) {
  const logs = getLogs();
  const x = logs[i];
  if (!x) return;
  editingIndex = i;

  document.getElementById("highlight").value = x.highlight;
  document.getElementById("block").value = x.block;
  document.getElementById("action").value = x.action;

  document.getElementById("statusText").textContent =
    "æ­£åœ¨ç¼–è¾‘ï¼Œä¿®æ”¹åå†æŒ‰ã€Œè®°å½•ã€å³å¯";
}

// ================================
// SAVE (Local + Google Sheet)
// ================================
async function save() {
  const highlight = document.getElementById("highlight").value.trim();
  const block = document.getElementById("block").value.trim();
  const action = document.getElementById("action").value.trim();
  const status = document.getElementById("statusText");

  if (!highlight && !block && !action) {
    alert("è‡³å°‘å†™ä¸€ç‚¹ç‚¹å–”ï¼");
    return;
  }

  let logs = getLogs();

  // ---- edit mode ----
  if (editingIndex !== null) {
    logs[editingIndex].highlight = highlight;
    logs[editingIndex].block = block;
    logs[editingIndex].action = action;

    setLogs(logs);
    renderLogs();
    editingIndex = null;
    status.textContent = "å·²æ›´æ–°ï¼ˆæœ¬åœ°ï¼‰ã€‚å¦‚éœ€åŒæ­¥ï¼Œåªéœ€æ–°å¢ä¸€æ¡è®°å½•ã€‚";
    return;
  }

  // ---- new record ----
  const date = new Date().toISOString().slice(0, 10);
  logs.unshift({ date, highlight, block, action });
  setLogs(logs);
  renderLogs();

  status.textContent = "å·²è®°å½•ï¼ˆæœ¬åœ°ï¼‰ï¼Œæ­£åœ¨åŒæ­¥åˆ° Google Sheetâ€¦";

  // ---- GOOGLE SHEET SYNC ----
  try {
    await fetch(SCRIPT_URL, {
      method: "POST",
      mode: "no-cors", // â­ å¿…é¡»æœ‰è¿™ä¸ª
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ date, highlight, block, action })
    });

    status.textContent = "å·²åŒæ­¥åˆ° Google Sheet âœ…ï¼ˆåå°å®Œæˆï¼‰";
  } catch (err) {
    console.error(err);
    status.textContent = "åŒæ­¥å¤±è´¥ï¼Œä½†æœ¬åœ°å·²ä¿å­˜ã€‚";
  }
}

// ================================
// ANALYZE (Local version)
// ================================
function analyze() {
  const logs = getLogs();
  if (!logs.length) return alert("è¿˜æ²¡æœ‰è®°å½•");

  const last7 = logs.slice(0,7);
  let output = `âœ¨ æœ€è¿‘ ${last7.length} å¤©ä½ éƒ½æœ‰åœ¨è®°å½•ï¼š\n\n`;

  output += last7.map(x => `â–  ${x.date}\näº®ç‚¹ï¼š${x.highlight}\nå¡ç‚¹ï¼š${x.block}\nåŠ¨ä½œï¼š${x.action}\n`).join("\n");

  alert(output);
}

// ================================
// EVENT
// ================================
document.getElementById("saveBtn").onclick = save;
document.getElementById("analyzeBtn").onclick = analyze;
renderLogs();

// ================================
// REGISTER SERVICE WORKER for PWA
// ================================
if ("serviceWorker" in navigator) {
  navigator.serviceWorker.register("./service-worker.js");
}
</script>

</body>
</html>
